name: 'Bellwether MCP Check'
description: 'Schema validation and drift detection for MCP servers'
author: 'Dotset Labs LLC'

#
# Required permissions for this action:
#   contents: read          # To read baseline files
#   security-events: write  # Required when upload-sarif is true (GitHub Code Scanning)
#
# Example workflow permissions:
#   permissions:
#     contents: read
#     security-events: write
#

branding:
  icon: 'shield'
  color: 'purple'

inputs:
  version:
    description: 'Bellwether npm version to install (defaults to action ref if semver)'
    required: false
    default: ''
  server-command:
    description: 'MCP server command to check (e.g., "npx @mcp/your-server")'
    required: true
  server-args:
    description: 'Arguments to pass to the server command'
    required: false
    default: ''
  config-path:
    description: 'Path to bellwether.yaml config file (required for all commands). If not found, creates one with --preset ci'
    required: false
    default: 'bellwether.yaml'
  baseline-path:
    description: 'Path to baseline file for drift comparison (relative to output.dir unless absolute)'
    required: false
    default: 'bellwether-baseline.json'
  save-baseline:
    description: 'Save baseline after check'
    default: 'false'
  output-dir:
    description: 'Directory for output files (must match bellwether.yaml output.dir/docsDir for artifacts)'
    default: '.'
  format:
    description: 'Output format: text, json, compact, github, markdown, junit, sarif'
    required: false
    default: 'github'
  min-severity:
    description: 'Minimum severity to report: none, info, warning, breaking'
    required: false
    default: 'info'
  fail-on-severity:
    description: 'Fail threshold severity: none, info, warning, breaking'
    required: false
    default: 'breaking'
  accept-drift:
    description: 'Accept detected drift as intentional and update baseline'
    required: false
    default: 'false'
  accept-reason:
    description: 'Reason for accepting drift (used with accept-drift: true)'
    required: false
    default: ''
  upload-sarif:
    description: 'Upload SARIF results to GitHub Code Scanning'
    required: false
    default: 'true'

outputs:
  result:
    description: 'Check result: passed or failed'
    value: ${{ steps.test.outputs.result }}
  exit-code:
    description: 'Semantic exit code: 0=clean, 1=info, 2=warning, 3=breaking, 4=error, 5=low-confidence'
    value: ${{ steps.test.outputs.exit-code }}
  severity:
    description: 'Highest change severity detected: none, info, warning, breaking, low_confidence'
    value: ${{ steps.test.outputs.severity }}
  drift-detected:
    description: 'Whether schema drift was detected (true/false)'
    value: ${{ steps.test.outputs.drift-detected }}
  tool-count:
    description: 'Number of tools discovered'
    value: ${{ steps.test.outputs.tool-count }}
  contract-md:
    description: 'Path to generated CONTRACT.md file'
    value: ${{ steps.test.outputs.contract-md }}
  baseline-file:
    description: 'Path to baseline file'
    value: ${{ steps.test.outputs.baseline-file }}
  sarif-file:
    description: 'Path to SARIF file (when format includes sarif)'
    value: ${{ steps.test.outputs.sarif-file }}
  junit-file:
    description: 'Path to JUnit XML file (when format includes junit)'
    value: ${{ steps.test.outputs.junit-file }}
  doc-score:
    description: 'Documentation quality score (0-100)'
    value: ${{ steps.test.outputs.doc-score }}
  doc-grade:
    description: 'Documentation quality grade (A-F)'
    value: ${{ steps.test.outputs.doc-grade }}
  security-findings:
    description: 'Number of security findings (when security testing is enabled)'
    value: ${{ steps.test.outputs.security-findings }}
  breaking-count:
    description: 'Number of breaking changes detected'
    value: ${{ steps.test.outputs.breaking-count }}
  warning-count:
    description: 'Number of warning-level changes detected'
    value: ${{ steps.test.outputs.warning-count }}
  info-count:
    description: 'Number of info-level changes detected'
    value: ${{ steps.test.outputs.info-count }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Bellwether
      shell: bash
      run: |
        VERSION_INPUT="${{ inputs.version }}"
        if [ -n "$VERSION_INPUT" ]; then
          VERSION="$VERSION_INPUT"
        else
          REF="${{ github.action_ref }}"
          if [[ "$REF" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            VERSION="${REF#v}"
          else
            echo "::error::Unable to determine Bellwether npm version from action ref '${REF}'."
            echo "::error::Use an exact semver action ref (e.g., v1.2.3) or set inputs.version."
            exit 1
          fi
        fi
        echo "Installing @dotsetlabs/bellwether@${VERSION}"
        npm install -g @dotsetlabs/bellwether@"${VERSION}"

    - name: Initialize Config (if needed)
      shell: bash
      run: |
        CONFIG_PATH="${{ inputs.config-path }}"
        DEFAULT_CONFIG="bellwether.yaml"
        if [ ! -f "$CONFIG_PATH" ]; then
          if [ "$CONFIG_PATH" != "$DEFAULT_CONFIG" ] && [ -f "$DEFAULT_CONFIG" ]; then
            mkdir -p "$(dirname "$CONFIG_PATH")"
            cp "$DEFAULT_CONFIG" "$CONFIG_PATH"
          else
            echo "::notice::Config not found, creating with --preset ci"
            bellwether init --preset ci ${{ inputs.server-command }} ${{ inputs.server-args }}
            if [ "$CONFIG_PATH" != "$DEFAULT_CONFIG" ]; then
              mkdir -p "$(dirname "$CONFIG_PATH")"
              mv "$DEFAULT_CONFIG" "$CONFIG_PATH"
            fi
          fi
        fi

    - name: Resolve Config Output Paths
      shell: bash
      run: |
        CONFIG_PATH="${{ inputs.config-path }}"
        CONFIG_META=$(node --input-type=module -e 'import fs from "fs"; import yaml from "yaml"; const path = process.argv[1]; const content = fs.readFileSync(path, "utf8"); const config = yaml.parse(content) || {}; const output = config.output || {}; const files = output.files || {}; const docsDir = output.docsDir || "."; const outputDir = output.dir || ".bellwether"; const contractFile = files.contractDoc || "CONTRACT.md"; const checkReport = files.checkReport || "bellwether-check.json"; console.log([docsDir, outputDir, contractFile, checkReport].join("|"));' "$CONFIG_PATH")
        IFS='|' read -r CONFIG_DOCS_DIR CONFIG_OUTPUT_DIR CONFIG_CONTRACT_FILE CONFIG_CHECK_REPORT <<< "$CONFIG_META"
        echo "BELLWETHER_CONFIG_DOCS_DIR=$CONFIG_DOCS_DIR" >> $GITHUB_ENV
        echo "BELLWETHER_CONFIG_OUTPUT_DIR=$CONFIG_OUTPUT_DIR" >> $GITHUB_ENV
        echo "BELLWETHER_CONFIG_CONTRACT_FILE=$CONFIG_CONTRACT_FILE" >> $GITHUB_ENV
        echo "BELLWETHER_CONFIG_CHECK_REPORT=$CONFIG_CHECK_REPORT" >> $GITHUB_ENV

    - name: Run Bellwether Check
      shell: bash
      id: test
      env:
        BELLWETHER_CI: 'true'
      run: |
        set +e

        CONFIG_PATH="${{ inputs.config-path }}"
        CONFIG_DOCS_DIR="${BELLWETHER_CONFIG_DOCS_DIR:-${{ inputs.output-dir }}}"
        CONFIG_OUTPUT_DIR="${BELLWETHER_CONFIG_OUTPUT_DIR:-${{ inputs.output-dir }}}"
        CONFIG_CONTRACT_FILE="${BELLWETHER_CONFIG_CONTRACT_FILE:-CONTRACT.md}"
        CONFIG_CHECK_REPORT="${BELLWETHER_CONFIG_CHECK_REPORT:-bellwether-check.json}"
        OUTPUT_DIR="${CONFIG_OUTPUT_DIR%/}"
        DOCS_DIR="${CONFIG_DOCS_DIR%/}"
        BASELINE_PATH_INPUT="${{ inputs.baseline-path }}"
        SAVE_BASELINE="${{ inputs.save-baseline }}"

        if [ -n "$OUTPUT_DIR" ] && [ ! -d "$OUTPUT_DIR" ]; then
          mkdir -p "$OUTPUT_DIR"
        fi

        if [ -n "$DOCS_DIR" ] && [ ! -d "$DOCS_DIR" ]; then
          mkdir -p "$DOCS_DIR"
        fi

        if [[ "$BASELINE_PATH_INPUT" = /* ]]; then
          BASELINE_PATH="$BASELINE_PATH_INPUT"
        else
          BASELINE_PATH="${OUTPUT_DIR}/${BASELINE_PATH_INPUT}"
        fi

        CONTRACT_MD="${DOCS_DIR}/${CONFIG_CONTRACT_FILE}"
        CHECK_REPORT_PATH="${OUTPUT_DIR}/${CONFIG_CHECK_REPORT}"

        echo "BELLWETHER_CONTRACT_PATH=$CONTRACT_MD" >> $GITHUB_ENV
        echo "BELLWETHER_CHECK_REPORT_PATH=$CHECK_REPORT_PATH" >> $GITHUB_ENV
        echo "BELLWETHER_BASELINE_PATH=$BASELINE_PATH" >> $GITHUB_ENV

        # Build check command flags
        CHECK_FLAGS="--config $CONFIG_PATH"

        # Severity options
        CHECK_FLAGS="$CHECK_FLAGS --min-severity ${{ inputs.min-severity }}"
        CHECK_FLAGS="$CHECK_FLAGS --fail-on-severity ${{ inputs.fail-on-severity }}"

        # Accept drift options
        if [ "${{ inputs.accept-drift }}" = "true" ]; then
          CHECK_FLAGS="$CHECK_FLAGS --accept-drift"
          if [ -n "${{ inputs.accept-reason }}" ]; then
            CHECK_FLAGS="$CHECK_FLAGS --accept-reason \"${{ inputs.accept-reason }}\""
          fi
        fi

        # Run check once with JSON output, then derive other formats
        echo "Running: bellwether check $CHECK_FLAGS --format json ${{ inputs.server-command }} ${{ inputs.server-args }}"
        bellwether check $CHECK_FLAGS --format json ${{ inputs.server-command }} ${{ inputs.server-args }} > "$CHECK_REPORT_PATH"
        CHECK_EXIT=$?

        # Parse JSON output for metrics and display
        if [ -f "$CHECK_REPORT_PATH" ]; then
          # Extract tool count
          TOOL_COUNT=$(node --input-type=module -e 'import fs from "fs"; const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8")); console.log((report.toolProfiles || []).length);' "$CHECK_REPORT_PATH" 2>/dev/null || echo "0")
          echo "tool-count=$TOOL_COUNT" >> $GITHUB_OUTPUT

          # Extract documentation quality from metadata
          DOC_SCORE=$(node --input-type=module -e 'import fs from "fs"; const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8")); console.log(report.metadata?.documentationScore?.overall ?? "");' "$CHECK_REPORT_PATH" 2>/dev/null || echo "")
          if [ -n "$DOC_SCORE" ] && [ "$DOC_SCORE" != "undefined" ]; then
            echo "doc-score=$DOC_SCORE" >> $GITHUB_OUTPUT
          fi

          # Extract security findings count
          SECURITY_FINDINGS=$(node --input-type=module -e 'import fs from "fs"; const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8")); const tools = report.capabilities?.tools || []; const count = tools.reduce((sum, t) => sum + (t.securityFingerprint?.findings?.length || 0), 0); console.log(count);' "$CHECK_REPORT_PATH" 2>/dev/null || echo "0")
          echo "security-findings=$SECURITY_FINDINGS" >> $GITHUB_OUTPUT
        else
          TOOL_COUNT="0"
          echo "tool-count=$TOOL_COUNT" >> $GITHUB_OUTPUT
          echo "security-findings=0" >> $GITHUB_OUTPUT
        fi

        # Display output in requested format (run again only if format is not json)
        if [ "${{ inputs.format }}" = "json" ]; then
          cat "$CHECK_REPORT_PATH"
        elif [ "${{ inputs.format }}" = "compact" ]; then
          bellwether check $CHECK_FLAGS --format compact ${{ inputs.server-command }} ${{ inputs.server-args }} 2>&1 || true
        else
          bellwether check $CHECK_FLAGS --format ${{ inputs.format }} ${{ inputs.server-command }} ${{ inputs.server-args }} 2>&1 || true
        fi

        # Set CONTRACT.md output path
        if [ -f "$CONTRACT_MD" ]; then
          echo "contract-md=$CONTRACT_MD" >> $GITHUB_OUTPUT
        fi

        # Set baseline file output
        echo "baseline-file=$BASELINE_PATH" >> $GITHUB_OUTPUT

        # Map exit code to severity (0.8.0 semantic exit codes)
        case $CHECK_EXIT in
          0) SEVERITY="none" ;;
          1) SEVERITY="info" ;;
          2) SEVERITY="warning" ;;
          3) SEVERITY="breaking" ;;
          4) SEVERITY="error" ;;
          5) SEVERITY="low_confidence" ;;
          *) SEVERITY="error" ;;
        esac
        echo "severity=$SEVERITY" >> $GITHUB_OUTPUT

        # Determine drift status from exit code
        if [ $CHECK_EXIT -ge 1 ] && [ $CHECK_EXIT -le 3 ]; then
          DRIFT_DETECTED="true"
        else
          DRIFT_DETECTED="false"
        fi
        echo "drift-detected=$DRIFT_DETECTED" >> $GITHUB_OUTPUT

        # Extract change counts from JSON if available
        if [ -f "$CHECK_REPORT_PATH" ]; then
          BREAKING_COUNT=$(node --input-type=module -e 'import fs from "fs"; const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8")); console.log(report.metadata?.diff?.breakingCount ?? 0);' "$CHECK_REPORT_PATH" 2>/dev/null || echo "0")
          WARNING_COUNT=$(node --input-type=module -e 'import fs from "fs"; const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8")); console.log(report.metadata?.diff?.warningCount ?? 0);' "$CHECK_REPORT_PATH" 2>/dev/null || echo "0")
          INFO_COUNT=$(node --input-type=module -e 'import fs from "fs"; const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8")); console.log(report.metadata?.diff?.infoCount ?? 0);' "$CHECK_REPORT_PATH" 2>/dev/null || echo "0")
        else
          BREAKING_COUNT="0"
          WARNING_COUNT="0"
          INFO_COUNT="0"
        fi
        echo "breaking-count=$BREAKING_COUNT" >> $GITHUB_OUTPUT
        echo "warning-count=$WARNING_COUNT" >> $GITHUB_OUTPUT
        echo "info-count=$INFO_COUNT" >> $GITHUB_OUTPUT

        # Save baseline if requested and check was clean
        if [ $CHECK_EXIT -eq 0 ] && [ "$SAVE_BASELINE" = "true" ]; then
          echo ""
          echo "Saving baseline to $BASELINE_PATH..."
          bellwether baseline save "$BASELINE_PATH" --force
        fi

        # Generate SARIF file for GitHub Code Scanning (convert from JSON to avoid re-running check)
        SARIF_FILE="${OUTPUT_DIR}/bellwether.sarif"
        if [ "${{ inputs.upload-sarif }}" = "true" ] && [ -f "$CHECK_REPORT_PATH" ]; then
          echo ""
          echo "Generating SARIF report from JSON..."
          node --input-type=module -e '
            import fs from "fs";
            const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8"));
            const sarif = {
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                "tool": {
                  "driver": {
                    "name": "Bellwether",
                    "version": report.metadata?.version || "1.0.0",
                    "informationUri": "https://github.com/dotsetlabs/bellwether",
                    "rules": []
                  }
                },
                "results": []
              }]
            };
            const run = sarif.runs[0];
            const diff = report.metadata?.diff;
            if (diff?.behaviorChanges) {
              for (const change of diff.behaviorChanges) {
                const level = change.severity === "breaking" ? "error" : change.severity === "warning" ? "warning" : "note";
                run.results.push({
                  "ruleId": `bellwether/${change.aspect}`,
                  "level": level,
                  "message": { "text": change.description || `${change.aspect} changed` },
                  "locations": [{
                    "physicalLocation": {
                      "artifactLocation": { "uri": "bellwether-baseline.json" },
                      "region": { "startLine": 1 }
                    }
                  }]
                });
              }
            }
            console.log(JSON.stringify(sarif, null, 2));
          ' "$CHECK_REPORT_PATH" > "$SARIF_FILE" 2>/dev/null || true
          if [ -f "$SARIF_FILE" ] && [ -s "$SARIF_FILE" ]; then
            echo "sarif-file=$SARIF_FILE" >> $GITHUB_OUTPUT
          fi
        fi

        # Generate JUnit file if requested (convert from JSON to avoid re-running check)
        if [ "${{ inputs.format }}" = "junit" ] && [ -f "$CHECK_REPORT_PATH" ]; then
          JUNIT_FILE="${OUTPUT_DIR}/bellwether-junit.xml"
          echo ""
          echo "Generating JUnit report from JSON..."
          node --input-type=module -e '
            import fs from "fs";
            const report = JSON.parse(fs.readFileSync(process.argv[1], "utf8"));
            const diff = report.metadata?.diff || {};
            const toolCount = (report.toolProfiles || []).length;
            const failures = diff.breakingCount || 0;
            const warnings = diff.warningCount || 0;
            const tests = Math.max(toolCount, 1);
            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
            xml += `<testsuites name="Bellwether MCP Check" tests="${tests}" failures="${failures}" errors="0">\n`;
            xml += `  <testsuite name="Schema Drift Detection" tests="${tests}" failures="${failures}" errors="0">\n`;
            if (diff.behaviorChanges) {
              for (const change of diff.behaviorChanges) {
                const escaped = (s) => String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
                if (change.severity === "breaking") {
                  xml += `    <testcase name="${escaped(change.tool)}: ${escaped(change.aspect)}">\n`;
                  xml += `      <failure message="${escaped(change.description)}">${escaped(change.before)} -> ${escaped(change.after)}</failure>\n`;
                  xml += `    </testcase>\n`;
                } else {
                  xml += `    <testcase name="${escaped(change.tool)}: ${escaped(change.aspect)}"/>\n`;
                }
              }
            } else {
              xml += `    <testcase name="No changes detected"/>\n`;
            }
            xml += `  </testsuite>\n`;
            xml += `</testsuites>\n`;
            console.log(xml);
          ' "$CHECK_REPORT_PATH" > "$JUNIT_FILE" 2>/dev/null || true
          if [ -f "$JUNIT_FILE" ] && [ -s "$JUNIT_FILE" ]; then
            echo "junit-file=$JUNIT_FILE" >> $GITHUB_OUTPUT
          fi
        fi

        # Set final outputs
        echo "exit-code=$CHECK_EXIT" >> $GITHUB_OUTPUT

        FAIL_THRESHOLD="${{ inputs.fail-on-severity }}"
        FAIL_THRESHOLD_LEVEL=3
        case "$FAIL_THRESHOLD" in
          none) FAIL_THRESHOLD_LEVEL=0 ;;
          info) FAIL_THRESHOLD_LEVEL=1 ;;
          warning) FAIL_THRESHOLD_LEVEL=2 ;;
          breaking) FAIL_THRESHOLD_LEVEL=3 ;;
        esac

        SHOULD_FAIL="false"
        if [ $CHECK_EXIT -eq 4 ] || [ $CHECK_EXIT -eq 5 ]; then
          SHOULD_FAIL="true"
        elif [ $CHECK_EXIT -ge 1 ] && [ $CHECK_EXIT -le 3 ]; then
          if [ $FAIL_THRESHOLD_LEVEL -gt 0 ] && [ $CHECK_EXIT -ge $FAIL_THRESHOLD_LEVEL ]; then
            SHOULD_FAIL="true"
          fi
        fi

        if [ "$SHOULD_FAIL" = "true" ]; then
          echo "result=failed" >> $GITHUB_OUTPUT
        else
          echo "result=passed" >> $GITHUB_OUTPUT
        fi

        if [ $CHECK_EXIT -eq 0 ]; then
          echo "::notice::Bellwether check passed - no drift detected"
        elif [ $CHECK_EXIT -eq 1 ]; then
          echo "::notice::Bellwether check: info-level changes detected (non-breaking)"
        elif [ $CHECK_EXIT -eq 2 ]; then
          echo "::warning::Bellwether check: warning-level changes detected"
        elif [ $CHECK_EXIT -eq 3 ]; then
          echo "::error::Bellwether check: breaking changes detected"
          echo ""
          echo "If changes are intentional, update your baseline:"
          echo "  bellwether baseline accept --reason \"Your reason here\" --force"
        elif [ $CHECK_EXIT -eq 5 ]; then
          echo "::warning::Bellwether check failed: low confidence metrics"
        else
          echo "::error::Bellwether check failed with error. Review the output above for details."
        fi

        if [ "$SHOULD_FAIL" = "true" ]; then
          exit $CHECK_EXIT
        fi
        exit 0

    - name: Upload CONTRACT.md artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bellwether-docs
        path: ${{ env.BELLWETHER_CONTRACT_PATH }}
        if-no-files-found: ignore

    - name: Upload baseline artifact
      if: inputs.save-baseline == 'true' && always()
      uses: actions/upload-artifact@v4
      with:
        name: bellwether-baseline
        path: ${{ env.BELLWETHER_BASELINE_PATH }}
        if-no-files-found: ignore

    - name: Upload JSON report artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bellwether-report
        path: ${{ env.BELLWETHER_CHECK_REPORT_PATH }}
        if-no-files-found: ignore

    - name: Upload SARIF to GitHub Code Scanning
      if: inputs.upload-sarif == 'true' && always() && steps.test.outputs.sarif-file != ''
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ${{ steps.test.outputs.sarif-file }}
        category: bellwether-mcp-check
      continue-on-error: true

    - name: Upload JUnit artifact
      if: inputs.format == 'junit' && always() && steps.test.outputs.junit-file != ''
      uses: actions/upload-artifact@v4
      with:
        name: bellwether-junit
        path: ${{ steps.test.outputs.junit-file }}
        if-no-files-found: ignore
